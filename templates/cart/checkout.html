{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - ConstCollection{% endblock %}

{% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="page-container py-12">
    <h1 class="section-title mb-8">Checkout</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Checkout Form -->
        <div class="lg:col-span-2">
            <form id="payment-form">
                {% csrf_token %}
                
                <!-- Shipping Information -->
                <div class="card p-6 mb-6">
                    <h2 class="font-playfair text-xl text-brand-indigo mb-6">Shipping Information</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="first_name" class="block font-inter text-sm text-gray-700 mb-2">First Name *</label>
                            <input type="text" id="first_name" name="first_name" required class="input-field">
                        </div>
                        <div>
                            <label for="last_name" class="block font-inter text-sm text-gray-700 mb-2">Last Name *</label>
                            <input type="text" id="last_name" name="last_name" required class="input-field">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="email" class="block font-inter text-sm text-gray-700 mb-2">Email *</label>
                            <input type="email" id="email" name="email" required class="input-field">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="address" class="block font-inter text-sm text-gray-700 mb-2">Address *</label>
                            <input type="text" id="address" name="address" required class="input-field">
                        </div>
                        <div>
                            <label for="city" class="block font-inter text-sm text-gray-700 mb-2">City *</label>
                            <input type="text" id="city" name="city" required class="input-field">
                        </div>
                        <div>
                            <label for="zip_code" class="block font-inter text-sm text-gray-700 mb-2">Postal Code *</label>
                            <input type="text" id="zip_code" name="zip_code" required class="input-field">
                        </div>
                        <div id="state-field" class="hidden">
                            <label for="state" class="block font-inter text-sm text-gray-700 mb-2">State/Province *</label>
                            <input type="text" id="state" name="state" class="input-field">
                        </div>
                        <div>
                            <label for="country" class="block font-inter text-sm text-gray-700 mb-2">Country *</label>
                            <select id="country" name="country" required class="input-field">
                                <option value="Sweden">Sweden</option>
                                <option value="Norway">Norway</option>
                                <option value="Denmark">Denmark</option>
                                <option value="Finland">Finland</option>
                                <option value="Germany">Germany</option>
                                <option value="France">France</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Netherlands">Netherlands</option>
                                <option value="Belgium">Belgium</option>
                                <option value="Austria">Austria</option>
                                <option value="Switzerland">Switzerland</option>
                                <option value="Italy">Italy</option>
                                <option value="Spain">Spain</option>
                                <option value="Portugal">Portugal</option>
                                <option value="Ireland">Ireland</option>
                                <option value="Poland">Poland</option>
                                <option value="United States">United States</option>
                                <option value="Canada">Canada</option>
                                <option value="Australia">Australia</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="card p-6 mb-6">
                    <h2 class="font-playfair text-xl text-brand-indigo mb-6">Payment Information</h2>
                    
                    <!-- Stripe Card Elements - Separate inputs -->
                    <div class="space-y-4">
                        <!-- Card Number -->
                        <div>
                            <label for="card-number" class="block font-inter text-sm text-gray-700 mb-2">Card Number *</label>
                            <div id="card-number" class="input-field p-4 bg-white"></div>
                        </div>
                        
                        <!-- Expiry and CVC Row - stacks on very small screens -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-1">
                                <label for="card-expiry" class="block font-inter text-sm text-gray-700 mb-2 whitespace-nowrap">Expiry *</label>
                                <div id="card-expiry" class="input-field p-4 bg-white"></div>
                            </div>
                            <div class="flex-1">
                                <label for="card-cvc" class="block font-inter text-sm text-gray-700 mb-2">CVC *</label>
                                <div id="card-cvc" class="input-field p-4 bg-white"></div>
                            </div>
                        </div>
                        
                        <!-- Card Errors -->
                        <div id="card-errors" class="text-sm text-red-600" role="alert"></div>
                    </div>
                    
                    <!-- Secure Payment Badge -->
                    <div class="flex flex-wrap items-center justify-center sm:justify-between gap-3 border-t border-gray-100 pt-4 mt-4">
                        <div class="flex items-center gap-2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            <span class="font-inter text-sm whitespace-nowrap">Secured by Stripe</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Visa -->
                            <svg class="h-8 w-auto" viewBox="0 0 50 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19.5 14.4H16.1L18.2 1.6H21.6L19.5 14.4Z" fill="#1A1F71"/>
                                <path d="M32.5 1.9C31.8 1.6 30.7 1.4 29.4 1.4C26.1 1.4 23.8 3.1 23.8 5.5C23.8 7.3 25.4 8.3 26.7 8.9C28 9.5 28.4 9.9 28.4 10.4C28.4 11.2 27.4 11.6 26.5 11.6C25.2 11.6 24.5 11.4 23.4 10.9L22.9 10.7L22.4 13.7C23.2 14.1 24.7 14.4 26.2 14.4C29.7 14.4 31.9 12.7 32 10.2C32 8.8 31.1 7.7 29.2 6.8C28 6.2 27.3 5.8 27.3 5.3C27.3 4.8 27.9 4.3 29.1 4.3C30.1 4.3 30.9 4.5 31.5 4.7L31.8 4.9L32.5 1.9Z" fill="#1A1F71"/>
                                <path d="M37.5 9.4C37.8 8.6 38.9 5.6 38.9 5.6C38.9 5.6 39.2 4.8 39.4 4.3L39.6 5.5C39.6 5.5 40.3 8.9 40.4 9.4H37.5ZM42.2 1.6H39.6C38.7 1.6 38.1 1.9 37.7 2.8L32.7 14.4H36.2C36.2 14.4 36.8 12.8 36.9 12.4H41.2C41.3 12.9 41.6 14.4 41.6 14.4H44.7L42.2 1.6Z" fill="#1A1F71"/>
                                <path d="M14.1 1.6L10.8 10.1L10.5 8.6C9.8 6.4 7.8 4 5.5 2.9L8.5 14.4H12L17.6 1.6H14.1Z" fill="#1A1F71"/>
                                <path d="M7.7 1.6H2.1L2 1.9C6.1 2.9 8.8 5.5 9.8 8.6L8.7 2.8C8.5 2 7.9 1.7 7.1 1.6H7.7Z" fill="#F9A533"/>
                            </svg>
                            <!-- Mastercard -->
                            <svg class="h-8 w-auto" viewBox="0 0 38 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="13" cy="12" r="9" fill="#EB001B"/>
                                <circle cx="25" cy="12" r="9" fill="#F79E1B"/>
                                <path d="M19 5.3C20.8 6.8 22 9.2 22 12C22 14.8 20.8 17.2 19 18.7C17.2 17.2 16 14.8 16 12C16 9.2 17.2 6.8 19 5.3Z" fill="#FF5F00"/>
                            </svg>
                            <!-- Amex -->
                            <svg class="h-8 w-auto" viewBox="0 0 38 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="38" height="24" rx="3" fill="#006FCF"/>
                                <path d="M7 15L9.5 8H12L14.5 15H12.3L11.8 13.5H9.7L9.2 15H7ZM10.1 12H11.4L10.75 10L10.1 12Z" fill="white"/>
                                <path d="M15 15V8H18.5L19.5 11.5L20.5 8H24V15H22V10.5L20.7 15H18.3L17 10.5V15H15Z" fill="white"/>
                                <path d="M25 15V8H30V9.5H27V10.8H29.8V12.3H27V13.5H30V15H25Z" fill="white"/>
                                <path d="M31 15L33 11.5L31 8H33.5L34.5 10L35.5 8H38L36 11.5L38 15H35.5L34.5 13L33.5 15H31Z" fill="white"/>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Test Card Info Box (Remove this section for production) -->
                    <div class="mt-4 bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <p class="font-inter font-medium text-amber-800 text-sm mb-2">Test Mode - Use these card details:</p>
                                <div class="font-mono text-sm text-amber-700 space-y-1">
                                    <p><span class="text-amber-600">Card:</span> 4242 4242 4242 4242</p>
                                    <p><span class="text-amber-600">Expiry:</span> Any future date (e.g., 12/28)</p>
                                    <p><span class="text-amber-600">CVC:</span> Any 3 digits (e.g., 123)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if error %}
                <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="font-inter text-sm text-red-700">{{ error }}</p>
                </div>
                {% endif %}

                <!-- Submit Button -->
                <button type="submit" id="submit-button" class="w-full btn-primary py-4 text-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <span id="button-text">Pay Now</span>
                    <span id="spinner" class="hidden">
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </form>

            <!-- Back to Cart -->
            <div class="mt-6">
                <a href="{% url 'cart' %}" class="font-inter text-brand-indigo hover:text-brand-indigo-dark transition-colors inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
                    </svg>
                    Back to Cart
                </a>
            </div>
        </div>

        <!-- Order Summary -->
        <div>
            {% include 'components/_cart_summary.html' with show_checkout_button=False %}
            
            <!-- Cart Items Preview -->
            <div class="mt-6 card p-6">
                <h3 class="font-inter font-semibold text-gray-900 mb-4">Items in Cart</h3>
                <div class="space-y-3">
                    {% for item in cart %}
                    <div class="flex gap-3">
                        <div class="w-12 h-12 rounded overflow-hidden bg-gray-100 flex-shrink-0">
                            <img 
                                src="{% get_media_prefix %}{{ item.image }}" 
                                alt="{{ item.name }}"
                                class="w-full h-full object-contain"
                            >
                        </div>
                        <div class="flex-grow">
                            <p class="font-inter text-sm text-gray-900 truncate">{{ item.name }}</p>
                            <p class="font-inter text-xs text-gray-500">Qty: {{ item.quantity }}</p>
                        </div>
                        <p class="font-inter text-sm font-semibold text-gray-900">
                            ${{ item.total_price|floatformat:2 }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Show/hide state field based on country
    const countrySelect = document.getElementById('country');
    const stateField = document.getElementById('state-field');
    const stateInput = document.getElementById('state');
    
    function toggleStateField() {
        const needsState = ['United States', 'Canada', 'Australia'].includes(countrySelect.value);
        if (needsState) {
            stateField.classList.remove('hidden');
            stateInput.required = true;
        } else {
            stateField.classList.add('hidden');
            stateInput.required = false;
            stateInput.value = '';
        }
    }
    
    countrySelect.addEventListener('change', toggleStateField);
    toggleStateField(); // Run on page load
    
    // Initialize Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    
    // Custom styling for the card elements
    const style = {
        base: {
            color: '#1f2937',
            fontFamily: '"Inter", system-ui, sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: '#9ca3af'
            }
        },
        invalid: {
            color: '#dc2626',
            iconColor: '#dc2626'
        }
    };
    
    // Create separate card elements
    const cardNumber = elements.create('cardNumber', { style: style, showIcon: true });
    const cardExpiry = elements.create('cardExpiry', { style: style });
    const cardCvc = elements.create('cardCvc', { style: style });
    
    // Mount elements
    cardNumber.mount('#card-number');
    cardExpiry.mount('#card-expiry');
    cardCvc.mount('#card-cvc');
    
    // Handle real-time validation errors for all elements
    const displayError = document.getElementById('card-errors');
    
    [cardNumber, cardExpiry, cardCvc].forEach(element => {
        element.on('change', function(event) {
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
    });
    
    // Handle form submission
    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Validate form fields - state only required for US/Canada
        const country = document.getElementById('country').value;
        const needsState = ['United States', 'Canada', 'Australia'].includes(country);
        const requiredFields = ['first_name', 'last_name', 'email', 'address', 'city', 'zip_code', 'country'];
        if (needsState) requiredFields.push('state');
        
        let isValid = true;
        
        for (const field of requiredFields) {
            const input = document.getElementById(field);
            if (!input.value.trim()) {
                input.classList.add('border-red-500');
                isValid = false;
            } else {
                input.classList.remove('border-red-500');
            }
        }
        
        if (!isValid) {
            return;
        }
        
        // Disable button and show spinner
        submitButton.disabled = true;
        buttonText.classList.add('hidden');
        spinner.classList.remove('hidden');
        
        // First, save shipping info to the server
        const formData = new FormData(form);
        try {
            const response = await fetch('{% url "process_payment" %}', {
                method: 'POST',
                body: formData,
            });
            
            if (!response.ok) {
                throw new Error('Failed to save shipping information');
            }
        } catch (error) {
            showError(error.message);
            return;
        }
        
        // Confirm the payment with Stripe
        const { error, paymentIntent } = await stripe.confirmCardPayment('{{ client_secret }}', {
            payment_method: {
                card: cardNumber,
                billing_details: {
                    name: `${document.getElementById('first_name').value} ${document.getElementById('last_name').value}`,
                    email: document.getElementById('email').value,
                    address: {
                        line1: document.getElementById('address').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        postal_code: document.getElementById('zip_code').value,
                        country: getCountryCode(document.getElementById('country').value),
                    }
                }
            }
        });
        
        if (error) {
            showError(error.message);
        } else if (paymentIntent.status === 'succeeded') {
            // Redirect to success page
            window.location.href = '{% url "checkout_success" %}?payment_intent=' + paymentIntent.id;
        }
    });
    
    function showError(message) {
        const displayError = document.getElementById('card-errors');
        displayError.textContent = message;
        submitButton.disabled = false;
        buttonText.classList.remove('hidden');
        spinner.classList.add('hidden');
    }
    
    function getCountryCode(country) {
        const codes = {
            'Sweden': 'SE',
            'Norway': 'NO',
            'Denmark': 'DK',
            'Finland': 'FI',
            'Germany': 'DE',
            'France': 'FR',
            'United Kingdom': 'GB',
            'Netherlands': 'NL',
            'Belgium': 'BE',
            'Austria': 'AT',
            'Switzerland': 'CH',
            'Italy': 'IT',
            'Spain': 'ES',
            'Portugal': 'PT',
            'Ireland': 'IE',
            'Poland': 'PL',
            'United States': 'US',
            'Canada': 'CA',
            'Australia': 'AU',
        };
        return codes[country] || 'SE';
    }
</script>
{% endblock %}
